{% extends 'esi_tracker/base-bs5.html' %}
{% load i18n %}
{% load humanize %}
{% block page_title %}ESI Status{% endblock %}
{% block content %}
    <h1 class="m-3 text-center">ESI Status</h1>
    <p class="m-3 text-center">As reported by the status endpoint</p>
    <div class="card m-3 mx-auto" style="max-width: 38em;" >
        <div class="card-body">
            <div class="d-flex" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Default tooltip1">
                <img width="64px" style="border-radius: 5px;" src="https://images.evetech.net/characters/90406623/portrait?size=1024" alt="characters 90406623 portrait">
                <div class="d-flex flex-column justify-content-center">
                    <h5 class="ms-2">
                        Ariel Rin for CSM19
                    </h5>
                    <div class="d-flex ms-2 align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M12 6h-6a2 2 0 0 0 -2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-6"></path><path d="M11 13l9 -9"></path><path d="M15 4h5v5"></path></svg>
                        <a href="https://forums.eveonline.com/t/ariel-rin-for-csm19/462992"  >CSM19 Forum Thread</a>
                    </div>
                </div>
            </div>
            <figure class="mt-3 mb-0" style="border: 1px solid var(--bs-info); border-left-width: 0.25rem; border-radius: 0.25rem; margin-bottom: 1rem; padding: 1rem;">
                <blockquote class="blockquote">
                    <p><small><em>CCP and Third Party Developers used to have a mutual goal of designing safe and effective tools, and it’s been my constant struggle to reignite that professional relationship for the benefit of all players. I’m running for CSM to bring ESI development back to a reliable, safe and game design approved state, in order to continue to push the envelope on community and social engagement in EVE.</em></small></p>
                </blockquote>
                <figcaption class="blockquote-footer mb-0">
                    <cite title="Source Title">Ariel Rin</cite>
                </figcaption>
            </figure>
        </div>
    </div>
    <div class="m-3 mx-auto" style="max-width: 1500px;" >
        <div class="card m-3">
            
            <div class="card-body text-center">
                <h4>Filters</h4>
                <p class="m-3 text-center">Overall satus averaged over time period</p>
                <div class="d-flex flex-row justify-content-around">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckRed" checked>
                        <label class="form-check-label" for="flexCheckRed">
                        Show Red Endpoints
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckYellow" checked>
                        <label class="form-check-label" for="flexCheckYellow">
                        Show Yellow Endpoints
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckGreen" checked>
                        <label class="form-check-label" for="flexCheckGreen">
                        Show Green Endpoints
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="m-3 mx-auto text-center" style="max-width: 1500px;" >
        {% for key, item in data.items %}
            <div class="card m-3 endpoint-block " id="{{item.name|slugify }}">
                <div class="card-body"><h4>{{item.name}}</h4></div>
                <div class="card-body w-100">
                    {% for ep, stat in item.endpoints.items %}
                        <div class="stat-{{stat.o|floatformat:'0'}} endpoint " id="{{ep|slugify }}">
                            <h6>{{ep}}</h6>
                            <div class="d-flex align-items-center mb-3" >
                                <p class="m-0 me-3">{{stat.first|date:'Y-m-d'}}</p>
                                    {% for date, status in stat.updates.items %}
                                        <div 
                                            style="height:2em;border-radius: 3px;" 
                                            class="bg-{% if status.o >= 2.5 %}success{% elif status.o >= 1.5 %}warning{% else %}danger{% endif %} flex-grow-1" 
                                            data-bs-toggle="tooltip" 
                                            data-bs-html="true"
                                            data-bs-placement="bottom" 
                                            data-bs-title="{{date}}</br>R:{{status.r}} Y:{{status.y}} G:{{status.g}}"> </div>
                                    {% endfor %}
                                <p class="m-0 ms-3">{{stat.last|date:'Y-m-d'}}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
{% endblock content %}

{% block extra_javascript %}

    <script>
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        
        const allBlocks = document.querySelectorAll('.endpoint-block')

        function hideStats(className) {
            const triggerList = document.querySelectorAll(className)
            const elList = [...triggerList].map(collapseEl => collapseEl.classList.toggle("d-none"))
            const blocks = [...allBlocks].map(block => {
                const children = block.querySelectorAll('.endpoint:not(.d-none)')
                console.log(block.id, children.length)
                if (children.length === 0){
                    block.classList.add("d-none")
                } else {
                    block.classList.remove("d-none")
                }
            })
        }

        $('#flexCheckRed').change(function() {
            hideStats('.stat-1')
        })

        $('#flexCheckYellow').change(function() {
            hideStats('.stat-2')
        })

        $('#flexCheckGreen').change(function() {
            hideStats('.stat-3')
        })

    </script>
{% endblock extra_javascript %}

